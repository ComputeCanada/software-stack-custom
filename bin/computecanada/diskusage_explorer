#!/bin/bash

if [[ "$#" -lt 1 ]]; then
  echo "Usage:   $0 parent_directory_in_project_space [--batch [options]]"
  echo "Syntaxe: $0 r√©pertoire_parent_dans_espace_projet [--batch [options]]"
  exit 1
fi

path="$1"

if [ ! -d "$path" ]; then
  echo "Error:  '$path' does not exist."
  echo "Erreur: '$path' n'existe pas."
  exit 1
fi

path=$(realpath $path)

if [[ ! "$path" =~ ^/lustre[[:digit:]]{2}/project/[[:digit:]]*/ ]]; then
  echo "Error: full path '$path' is not in a project space."
  echo "Erreur: le chemin '$path' n'est pas dans un espace projet."
  exit 1
fi

gid=$(echo $path | awk -F "/" '{print $4}')
gname=$(id | cut -d' ' -f3 | cut -d= -f2 | tr , '\n' | grep $gid | cut -d'(' -f2 | cut -d')' -f1)

duc_db="/project/.duc_databases/${gname}.sqlite"
query_path=$(echo $path | sed -e "s_^/lustre[0-9]\{2\}__g;s_/$gid/_/$gname/_g")

if [ "$2" = "--batch" ]; then
  duc ls $3 --database=${duc_db} $query_path
else
  duc ui --database=${duc_db} $query_path
fi
